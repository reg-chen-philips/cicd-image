# Use the official TeamCity Build Agent base image
FROM jetbrains/teamcity-agent:latest

# Switch to root to perform installations
USER root

# Install dependencies for .NET
RUN apt-get update && apt-get install -y \
    curl \
    libicu-dev \
    && rm -rf /var/lib/apt/lists/*

# Download and run the official Microsoft .NET install script
# We specify 'STS' or a specific version to target .NET 10
RUN curl -sSL https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh \
    && chmod +x ./dotnet-install.sh \
    && ./dotnet-install.sh --channel 10.0 --install-dir /usr/share/dotnet \
    && ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet \
    && rm dotnet-install.sh

# Set environment variables so the agent recognizes the SDK
ENV DOTNET_ROOT=/usr/share/dotnet
ENV PATH=$PATH:/usr/share/dotnet

# Switch back to the buildagent user for security
USER buildagent

# Verify installation
RUN dotnet --version
